{"title":"Access Control 學習筆記","date":"2024-02-19T08:14:00.000Z","date_formatted":{"ll":"Feb 19, 2024","L":"02/19/2024","MM-DD":"02-19"},"author":"plusC","link":"Access-Control-學習筆記","comments":true,"tags":["Web Security","portswigger","學習筆記"],"categories":["筆記"],"updated":"2024-02-19T08:25:06.556Z","content":"<p>網頁應用的 access control 仰賴於：</p>\n<ul>\n<li>authentication</li>\n<li>session 管理</li>\n</ul>\n<h2 id=\"垂直提權：可以拿到無權存取的更高權限\">垂直提權：可以拿到無權存取的更高權限<a title=\"#垂直提權：可以拿到無權存取的更高權限\" href=\"#垂直提權：可以拿到無權存取的更高權限\"></a></h2>\n<p>e.g. 拿到管理者權限</p>\n<h3 id=\"用參數控制存取權\">用參數控制存取權<a title=\"#用參數控制存取權\" href=\"#用參數控制存取權\"></a></h3>\n<p>有些應用程式在登入的時候確認使用者的存取權限並存在使用者可以控制的地方，例如：</p>\n<ul>\n<li>隱藏的字段</li>\n<li>cookie</li>\n<li>預設的查詢字串參數</li>\n</ul>\n<p>應用程式根據提交的值做出存取控制決策。例如：</p>\n<figure class=\"highlight jsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">https</span>:<span class=\"comment\">//insecure-website.com/login/home.jsp?admin=true</span></span><br><span class=\"line\"><span class=\"attr\">https</span>:<span class=\"comment\">//insecure-website.com/login/home.jsp?role=1</span></span><br></pre></td></tr></table></figure>\n<p>但這樣做是不安全的，因為使用者有機會可以修改值並存取到未授權的功能</p>\n<h3 id=\"攻擊手法\">攻擊手法<a title=\"#攻擊手法\" href=\"#攻擊手法\"></a></h3>\n<p>敏感的網頁可能會暴露在 robots.txt 中或是攻擊者可以用字典檔透過暴力法去找敏感網頁</p>\n<figure class=\"highlight jsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">https</span>:<span class=\"comment\">//insecure-website.com/robots.txt</span></span><br></pre></td></tr></table></figure>\n<p>另外，網頁的 JavaScript 也有可能洩漏敏感網頁：</p>\n<figure class=\"highlight jsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">\t<span class=\"keyword\">var</span> isAdmin = <span class=\"literal\">false</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (isAdmin) &#123;</span><br><span class=\"line\">\t\t...</span><br><span class=\"line\">\t\t<span class=\"keyword\">var</span> adminPanelTag = <span class=\"variable language_\">document</span>.<span class=\"title function_\">createElement</span>(<span class=\"string\">&#x27;a&#x27;</span>);</span><br><span class=\"line\">\t\tadminPanelTag.<span class=\"title function_\">setAttribute</span>(<span class=\"string\">&#x27;https://insecure-website.com/administrator-panel-yb556&#x27;</span>);</span><br><span class=\"line\">\t\tadminPanelTag.<span class=\"property\">innerText</span> = <span class=\"string\">&#x27;Admin panel&#x27;</span>;</span><br><span class=\"line\">\t\t...</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"lab:-unprotected-admin-functionality-with-unpredictable-url\"><strong>Lab: Unprotected admin functionality with unpredictable URL</strong><a title=\"#lab:-unprotected-admin-functionality-with-unpredictable-url\" href=\"#lab:-unprotected-admin-functionality-with-unpredictable-url\"></a></h3>\n<p>可以看到 script 藏在 body 中間：</p>\n<p><img src=\"/images/pasted-14.png\" alt=\"upload successful\" loading=\"lazy\" class=\"φbp\"></p>\n<p>網址改成：</p>\n<figure class=\"highlight jsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">https</span>:<span class=\"comment\">//0a56009e030460bb822f100b00e200ff.web-security-academy.net/admin-eod8pa</span></span><br></pre></td></tr></table></figure>\n<p>就可以成功拿到 admin panel 了~</p>\n<h3 id=\"lab:-user-role-controlled-by-request-parameter\"><strong>Lab: User role controlled by request parameter</strong><a title=\"#lab:-user-role-controlled-by-request-parameter\" href=\"#lab:-user-role-controlled-by-request-parameter\"></a></h3>\n<p>一開始直接在網址後面加上 <code>/admin</code> 會跳出沒有權限的頁面</p>\n<p>依照題目的指示登入帳密：<code>wiener:peter</code> 後會發現多了一個 cookie，<code>Name=Admin</code> <code>Value=false</code></p>\n<p><img src=\"/images/pasted-15.png\" alt=\"upload successful\" loading=\"lazy\" class=\"φbp\"></p>\n<p>猜測是用這個變數來控制存取權</p>\n<p>把 Value 改成 true 之後就可以成功拿到 admin panel</p>\n<h2 id=\"水平提權：可以存取其他相同權限使用者的資源\">水平提權：可以存取其他相同權限使用者的資源<a title=\"#水平提權：可以存取其他相同權限使用者的資源\" href=\"#水平提權：可以存取其他相同權限使用者的資源\"></a></h2>\n<h3 id=\"攻擊手法-1\">攻擊手法<a title=\"#攻擊手法-1\" href=\"#攻擊手法-1\"></a></h3>\n<p>假如使用者透過以下 URL 存取自己的帳戶頁面：</p>\n<figure class=\"highlight jsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">https</span>:<span class=\"comment\">//insecure-website.com/myaccount?id=123</span></span><br></pre></td></tr></table></figure>\n<p>則將 <code>id</code> 參數值改成其他使用者的值，就有可能可以獲得其他使用者的帳戶頁面以及相關功能的存取權</p>\n<blockquote>\n<p>這是不安全的直接物件參考 (Insecure Direct Object Reference, IDOR) 漏洞的範例。當使用者控制參數值用於直接存取資源或功能時，就會出現此類漏洞。</p>\n</blockquote>\n<p>在某些應用中，可利用的參數沒有可預測的值。例如，應用程式可以使用全域唯一識別碼 (Globally Unique Identifiers, GUID) 來識別用戶，而不是遞增的數字。這可以防止攻擊者猜測或預測另一個使用者的識別碼。然而，屬於其他用戶的 GUID 可能會在應用程式中引用用戶的其他地方公開，例如用戶訊息或評論</p>\n<h3 id=\"lab:-user-id-controlled-by-request-parameter,-with-unpredictable-user-ids\"><strong>Lab: User ID controlled by request parameter, with unpredictable user IDs</strong><a title=\"#lab:-user-id-controlled-by-request-parameter,-with-unpredictable-user-ids\" href=\"#lab:-user-id-controlled-by-request-parameter,-with-unpredictable-user-ids\"></a></h3>\n<p>先找到 <code>carlos</code> 的文章</p>\n<p>點下去後就可以發現網址中帶有 <code>carlos</code> 的 GUID ：</p>\n<figure class=\"highlight jsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">https</span>:<span class=\"comment\">//0af6004903087c62819720dd00aa00d8.web-security-academy.net/blogs?userId=96bffc69-9f2b-4590-9893-5954027a2f84</span></span><br></pre></td></tr></table></figure>\n<p>回到登入頁面，送出題目提供的帳密後可以看到原本的 API Key</p>\n<p>再重刷頁面擷取 request：</p>\n<figure class=\"highlight jsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">GET</span> /my-account?id=09425c50-807f-4d1b-b1c9-95ccc7fd65b5 <span class=\"variable constant_\">HTTP</span>/<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"title class_\">Host</span>: 0af6004903087c62819720dd00aa00d8.<span class=\"property\">web</span>-security-academy.<span class=\"property\">net</span></span><br><span class=\"line\"><span class=\"title class_\">Cookie</span>: session=bJbuS3uECMf5BpR8Y6itMVDAtH6CAeB4</span><br><span class=\"line\"><span class=\"title class_\">Cache</span>-<span class=\"title class_\">Control</span>: max-age=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"title class_\">Sec</span>-<span class=\"title class_\">Ch</span>-<span class=\"title class_\">Ua</span>: <span class=\"string\">&quot;Not A(Brand&quot;</span>;v=<span class=\"string\">&quot;99&quot;</span>, <span class=\"string\">&quot;Google Chrome&quot;</span>;v=<span class=\"string\">&quot;121&quot;</span>, <span class=\"string\">&quot;Chromium&quot;</span>;v=<span class=\"string\">&quot;121&quot;</span></span><br><span class=\"line\"><span class=\"title class_\">Sec</span>-<span class=\"title class_\">Ch</span>-<span class=\"title class_\">Ua</span>-<span class=\"title class_\">Mobile</span>: ?<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"title class_\">Sec</span>-<span class=\"title class_\">Ch</span>-<span class=\"title class_\">Ua</span>-<span class=\"title class_\">Platform</span>: <span class=\"string\">&quot;Windows&quot;</span></span><br><span class=\"line\"><span class=\"title class_\">Upgrade</span>-<span class=\"title class_\">Insecure</span>-<span class=\"title class_\">Requests</span>: <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"title class_\">User</span>-<span class=\"title class_\">Agent</span>: <span class=\"title class_\">Mozilla</span>/<span class=\"number\">5.0</span> (<span class=\"title class_\">Windows</span> <span class=\"variable constant_\">NT</span> <span class=\"number\">10.0</span>; <span class=\"title class_\">Win64</span>; x64) <span class=\"title class_\">AppleWebKit</span>/<span class=\"number\">537.36</span> (<span class=\"variable constant_\">KHTML</span>, like <span class=\"title class_\">Gecko</span>) <span class=\"title class_\">Chrome</span>/<span class=\"number\">121.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span> <span class=\"title class_\">Safari</span>/<span class=\"number\">537.36</span></span><br><span class=\"line\"><span class=\"title class_\">Accept</span>: text/html,application/xhtml+xml,application/xml;q=<span class=\"number\">0.9</span>,image/avif,image/webp,image/apng,*<span class=\"comment\">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class=\"line\"><span class=\"comment\">Sec-Fetch-Site: same-origin</span></span><br><span class=\"line\"><span class=\"comment\">Sec-Fetch-Mode: navigate</span></span><br><span class=\"line\"><span class=\"comment\">Sec-Fetch-User: ?1</span></span><br><span class=\"line\"><span class=\"comment\">Sec-Fetch-Dest: document</span></span><br><span class=\"line\"><span class=\"comment\">Referer: https://0af6004903087c62819720dd00aa00d8.web-security-academy.net/login</span></span><br><span class=\"line\"><span class=\"comment\">Accept-Encoding: gzip, deflate, br</span></span><br><span class=\"line\"><span class=\"comment\">Accept-Language: zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7</span></span><br></pre></td></tr></table></figure>\n<p>將 request 的 id 改成 carlos 的 GUID 後就可以拿到他的 API Key 了</p>\n<h2 id=\"水平到垂直的提權\">水平到垂直的提權<a title=\"#水平到垂直的提權\" href=\"#水平到垂直的提權\"></a></h2>\n<p>透過損害更有特權的用戶，水平權限升級攻擊可以轉變為垂直權限升級</p>\n<p>例如，水平升級可能允許攻擊者重設或捕獲屬於另一個使用者的密碼，如果攻擊者以管理使用者為目標並危害其帳戶，那麼他們可以獲得管理存取權限，從而執行垂直權限升級</p>\n<h3 id=\"lab:-user-id-controlled-by-request-parameter-with-password-disclosure\"><strong>Lab: User ID controlled by request parameter with password disclosure</strong><a title=\"#lab:-user-id-controlled-by-request-parameter-with-password-disclosure\" href=\"#lab:-user-id-controlled-by-request-parameter-with-password-disclosure\"></a></h3>\n<p>先使用題目提供的帳密登入</p>\n<p>擷取到 request：</p>\n<figure class=\"highlight jsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable constant_\">GET</span> /my-account?id=wiener <span class=\"variable constant_\">HTTP</span>/<span class=\"number\">2</span></span><br><span class=\"line\"><span class=\"title class_\">Host</span>: 0a5500290397ee35812f61e400580034.<span class=\"property\">web</span>-security-academy.<span class=\"property\">net</span></span><br><span class=\"line\"><span class=\"title class_\">Cookie</span>: session=9JVap7la6eU0aaaYa21JjEV47cvBon1E</span><br><span class=\"line\"><span class=\"title class_\">Cache</span>-<span class=\"title class_\">Control</span>: max-age=<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"title class_\">Sec</span>-<span class=\"title class_\">Ch</span>-<span class=\"title class_\">Ua</span>: <span class=\"string\">&quot;Not A(Brand&quot;</span>;v=<span class=\"string\">&quot;99&quot;</span>, <span class=\"string\">&quot;Google Chrome&quot;</span>;v=<span class=\"string\">&quot;121&quot;</span>, <span class=\"string\">&quot;Chromium&quot;</span>;v=<span class=\"string\">&quot;121&quot;</span></span><br><span class=\"line\"><span class=\"title class_\">Sec</span>-<span class=\"title class_\">Ch</span>-<span class=\"title class_\">Ua</span>-<span class=\"title class_\">Mobile</span>: ?<span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"title class_\">Sec</span>-<span class=\"title class_\">Ch</span>-<span class=\"title class_\">Ua</span>-<span class=\"title class_\">Platform</span>: <span class=\"string\">&quot;Windows&quot;</span></span><br><span class=\"line\"><span class=\"title class_\">Upgrade</span>-<span class=\"title class_\">Insecure</span>-<span class=\"title class_\">Requests</span>: <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"title class_\">User</span>-<span class=\"title class_\">Agent</span>: <span class=\"title class_\">Mozilla</span>/<span class=\"number\">5.0</span> (<span class=\"title class_\">Windows</span> <span class=\"variable constant_\">NT</span> <span class=\"number\">10.0</span>; <span class=\"title class_\">Win64</span>; x64) <span class=\"title class_\">AppleWebKit</span>/<span class=\"number\">537.36</span> (<span class=\"variable constant_\">KHTML</span>, like <span class=\"title class_\">Gecko</span>) <span class=\"title class_\">Chrome</span>/<span class=\"number\">121.0</span><span class=\"number\">.0</span><span class=\"number\">.0</span> <span class=\"title class_\">Safari</span>/<span class=\"number\">537.36</span></span><br><span class=\"line\"><span class=\"title class_\">Accept</span>: text/html,application/xhtml+xml,application/xml;q=<span class=\"number\">0.9</span>,image/avif,image/webp,image/apng,*<span class=\"comment\">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class=\"line\"><span class=\"comment\">Sec-Fetch-Site: same-origin</span></span><br><span class=\"line\"><span class=\"comment\">Sec-Fetch-Mode: navigate</span></span><br><span class=\"line\"><span class=\"comment\">Sec-Fetch-User: ?1</span></span><br><span class=\"line\"><span class=\"comment\">Sec-Fetch-Dest: document</span></span><br><span class=\"line\"><span class=\"comment\">Referer: https://0a5500290397ee35812f61e400580034.web-security-academy.net/login</span></span><br><span class=\"line\"><span class=\"comment\">Accept-Encoding: gzip, deflate, br</span></span><br><span class=\"line\"><span class=\"comment\">Accept-Language: zh-TW,zh;q=0.9,en-US;q=0.8,en;q=0.7</span></span><br></pre></td></tr></table></figure>\n<p>把 <code>id=wiener</code> 改成 <code>id=administrator</code> 後送出</p>\n<p>從 response 中就可以拿到管理者的密碼 <code>ambfil2by1q1e0u41mqz</code>：</p>\n<figure class=\"highlight jsx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;input required type=password name=password value=<span class=\"string\">&#x27;ambfil2by1q1e0u41mqz&#x27;</span>/&gt;</span><br></pre></td></tr></table></figure>\n<p>重新登入管理者的帳密後就可以拿到 admin panel 了~</p>\n<h2 id=\"參考資料\">參考資料<a title=\"#參考資料\" href=\"#參考資料\"></a></h2>\n<p><a href=\"https://portswigger.net/web-security/learning-paths/server-side-vulnerabilities-apprentice/access-control-apprentice/access-control/what-is-access-control\" target=\"_blank\">https://portswigger.net/web-security/learning-paths/server-side-vulnerabilities-apprentice/access-control-apprentice/access-control/what-is-access-control</a></p>\n","prev":{"title":"WebDecode - writeup","link":"WebDecode-writeup"},"next":{"title":"Path Traversal(Directory Traversal) 學習筆記","link":"Path-Traversal-學習筆記"},"plink":"https://pluscat.me/Access-Control-學習筆記/","toc":[{"id":"垂直提權：可以拿到無權存取的更高權限","title":"垂直提權：可以拿到無權存取的更高權限","index":"1","children":[{"id":"用參數控制存取權","title":"用參數控制存取權","index":"1.1"},{"id":"攻擊手法","title":"攻擊手法","index":"1.2"},{"id":"lab:-unprotected-admin-functionality-with-unpredictable-url","title":"Lab: Unprotected admin functionality with unpredictable URL","index":"1.3"},{"id":"lab:-user-role-controlled-by-request-parameter","title":"Lab: User role controlled by request parameter","index":"1.4"}]},{"id":"水平提權：可以存取其他相同權限使用者的資源","title":"水平提權：可以存取其他相同權限使用者的資源","index":"2","children":[{"id":"攻擊手法-1","title":"攻擊手法","index":"2.1"},{"id":"lab:-user-id-controlled-by-request-parameter,-with-unpredictable-user-ids","title":"Lab: User ID controlled by request parameter, with unpredictable user IDs","index":"2.2"}]},{"id":"水平到垂直的提權","title":"水平到垂直的提權","index":"3","children":[{"id":"lab:-user-id-controlled-by-request-parameter-with-password-disclosure","title":"Lab: User ID controlled by request parameter with password disclosure","index":"3.1"}]},{"id":"參考資料","title":"參考資料","index":"4"}],"reading_time":"1322 words in 9 min"}